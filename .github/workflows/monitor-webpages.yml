name: Monitor webpages (Playwright snapshot → GitHub Issue)

on:
  workflow_dispatch: {}

permissions:
  contents: read
  issues: write

jobs:
  monitor:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Playwright
        run: |
          npm install -D @playwright/test
          npx playwright install --with-deps chromium

      - name: Run Playwright tests (four.meme)
        id: fourmeme
        shell: bash
        run: |
          set -o pipefail
          mkdir -p test-results
          npx playwright test tests/fourmeme.spec.ts 2>&1 | tee test-results/fourmeme.log
        env:
          TARGET_URL: https://four.meme/create-token
        continue-on-error: true

      - name: Run Playwright tests (flap.sh)
        id: flap
        shell: bash
        run: |
          set -o pipefail
          mkdir -p test-results
          npx playwright test tests/flap-launch.spec.ts 2>&1 | tee test-results/flap.log
        continue-on-error: true

      - name: Create GitHub Issue when four.meme changed
        if: steps.fourmeme.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const when = new Date().toISOString();
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const fs = require('fs');
            const path = require('path');
            const issueLabel = 'webpage-monitor';
            const issueTitlePrefix = 'four.meme monitor failed';

            function readLog(logFileName) {
              const filePath = path.join(process.cwd(), 'test-results', logFileName);
              if (!fs.existsSync(filePath)) return null;
              const text = fs.readFileSync(filePath, 'utf8');
              const max = 8000;
              if (text.length <= max) return text.trim();
              return `${text.slice(-max)}\n...log truncated (tail)...`;
            }

            const runs = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: context.workflow,
              per_page: 2
            });
            const previousRun = runs.data.workflow_runs.find(run => run.id !== context.runId);
            const previousUrl = previousRun ? previousRun.html_url : null;
            const logText = readLog('fourmeme.log');

            const body = [
              'Playwright 测试失败（可能是页面变化、选择器失效、超时、网络等原因）。',
              `Actions 运行详情： ${runUrl}`,
              `上一次运行： ${previousUrl || '未找到上一条记录'}`,
              'Playwright failure log（节选）：',
              '```',
              logText || 'Log unavailable.',
              '```',
              '监控范围：',
              '- Launch your token 表单（整体）',
              '- Raised Token 下拉菜单（新增 token 项会触发）'
            ].join('\n');

            const existing = await github.rest.search.issuesAndPullRequests({
              q: `repo:${context.repo.owner}/${context.repo.repo} is:issue is:open label:${issueLabel} in:title "${issueTitlePrefix}"`
            });
            const issue = existing.data.items[0];

            if (issue) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                title: `${issueTitlePrefix} @ ${when}`,
                body
              });
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `${issueTitlePrefix} @ ${when}`,
                body,
                labels: [issueLabel]
              });
            }

      - name: Create GitHub Issue when flap.sh changed
        if: steps.flap.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const when = new Date().toISOString();
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const fs = require('fs');
            const path = require('path');
            const issueLabel = 'webpage-monitor';
            const issueTitlePrefix = 'flap.sh monitor failed';

            function readLog(logFileName) {
              const filePath = path.join(process.cwd(), 'test-results', logFileName);
              if (!fs.existsSync(filePath)) return null;
              const text = fs.readFileSync(filePath, 'utf8');
              const max = 8000;
              if (text.length <= max) return text.trim();
              return `${text.slice(-max)}\n...log truncated (tail)...`;
            }

            const runs = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: context.workflow,
              per_page: 2
            });
            const previousRun = runs.data.workflow_runs.find(run => run.id !== context.runId);
            const previousUrl = previousRun ? previousRun.html_url : null;
            const logText = readLog('flap.log');

            const body = [
              'Playwright 测试失败（可能是页面变化、选择器失效、超时、网络等原因）。',
              `Actions 运行详情： ${runUrl}`,
              `上一次运行： ${previousUrl || '未找到上一条记录'}`,
              'Playwright failure log（节选）：',
              '```',
              logText || 'Log unavailable.',
              '```',
              '监控范围：',
              '- Create Token 表单内的 Tax Settings 模块（Enable Tax 打开后）'
            ].join('\n');

            const existing = await github.rest.search.issuesAndPullRequests({
              q: `repo:${context.repo.owner}/${context.repo.repo} is:issue is:open label:${issueLabel} in:title "${issueTitlePrefix}"`
            });
            const issue = existing.data.items[0];

            if (issue) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                title: `${issueTitlePrefix} @ ${when}`,
                body
              });
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `${issueTitlePrefix} @ ${when}`,
                body,
                labels: [issueLabel]
              });
            }

      - name: Fail job if changed
        if: steps.fourmeme.outcome == 'failure' || steps.flap.outcome == 'failure'
        run: exit 1
